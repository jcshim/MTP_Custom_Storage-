STM32에서 \*\*MTP 방식(Media Transfer Protocol)\*\*을 구현하고, **SDMMC(Secure Digital MultiMediaCard) 인터페이스**를 통해 SD카드를 사용하려는 경우, CubeMX + FATFS + USB Device 스택 + USBX(MTP) 또는 Custom MTP 스택을 통합해야 합니다. 이 과정에서 **공부하고 익혀야 할 주요 기술 목록**을 아래에 체계적으로 정리했습니다.

---

## ✅ 1. **기초 개념**

### 📚 반드시 이해해야 할 배경지식

* [ ] STM32 아키텍처 (Cortex-M7, H7 계열 RAM/Flash 구조 포함)
* [ ] USB 기본 구조 및 USB 장치 클래스 개요 (특히 MTP, MSC)
* [ ] SD 카드 동작 원리 (SD/SDHC/SDXC, SPI vs SDIO/SDMMC)
* [ ] FAT 파일 시스템 구조 (FAT12/16/32, 디렉토리, 클러스터 등)

---

## ✅ 2. **CubeMX 설정 항목**

### 🛠 실습 중심의 설정 능력

* [ ] USB Device 설정 (Class: **Custom Class** 또는 USBX 활성화)
* [ ] SDMMC1/2 핀 및 클럭 설정
* [ ] FATFS 활성화 및 인터페이스 선택 (User-defined, SD Card with DMA 등)
* [ ] DMA 설정 (SDMMC, USB Tx/Rx에 필수)
* [ ] 중단 처리(Interrupts), NVIC 우선순위 조정

---

## ✅ 3. **SDMMC + FATFS 실습**

### 💾 SD 카드 저장/읽기 테스트 구현

* [ ] SD 카드 드라이버 (`bsp_driver_sd.c`, `sd_diskio.c`) 구조 파악
* [ ] `FATFS` 함수 사용법 (e.g., `f_open()`, `f_write()`, `f_read()`, `f_mount()`)
* [ ] 파일 생성/삭제/탐색/폴더 구조 실습
* [ ] DMA + SDMMC 조합 성능 최적화
* [ ] `MX_FATFS_Init()` 함수 구조 분석

---

## ✅ 4. **USB Device 스택 이해**

### 🔌 USB 통신의 흐름 이해

* [ ] `usbd_core.c/h`, `usbd_ctlreq.c`, `usbd_desc.c` 파일 구조
* [ ] Descriptor 구조 (Device, Configuration, Interface, Endpoint)
* [ ] USB 요청 처리 흐름 (Setup → Control IN/OUT → Data IN/OUT)
* [ ] 사용자 정의 USB Class 생성 방법 (`usbd_mtp.c/h` 등)

---

## ✅ 5. **MTP 프로토콜 이해**

### 🧩 PTP & MTP 프로토콜 분석

* [ ] MTP란? (Media Transfer Protocol vs MSC 비교)
* [ ] MTP 기본 구조 (Container, Operation Code, Object Format 등)
* [ ] PIMA 15740 표준 구조 이해
* [ ] MTP 객체 리스트 관리 및 파일 정보 전송 방식 이해
* [ ] 파일 전송 흐름: PC 요청 → 장치 응답 → 파일 전송 단계

---

## ✅ 6. **USBX + MTP 연동 (선택 사항)**

> ST의 **USBX(Ux\_Device\_PIMA\_MTP)** 예제 활용 시

* [ ] USBX의 개념과 구조 (ThreadX 기반)
* [ ] Ux\_Device stack 초기화 및 등록 방식
* [ ] `ux_device_class_pima`, `ux_device_stack_initialize()` 분석
* [ ] FileX 또는 FATFS 연동을 위한 래퍼 함수 구현

---

## ✅ 7. **Custom MTP 응답 처리 로직**

### 🧠 직접 처리하는 경우

* [ ] MTP 명령어(Operation Code)에 따른 상태 처리
* [ ] `GetObjectHandles`, `SendObject`, `GetObject`, `DeleteObject` 처리 함수 작성
* [ ] 파일 필터링 처리 (`.hwp`, `.txt`, `.doc`만 허용 등)
* [ ] MTP Container 포맷 정의 (Header, Payload 등)
* [ ] PC와의 동기화 흐름: 요청 → 응답 → 상태 통지

---

## ✅ 8. **디버깅 및 성능 최적화**

### 🧪 통합 시 꼭 필요한 확인

* [ ] Logic Analyzer나 USB Protocol Analyzer 사용법
* [ ] STM32CubeMonitor, ITM, UART 로그 활용 디버깅
* [ ] PC ↔ STM32 간 전송 속도 분석
* [ ] USB FIFO/Buffer 설정 최적화
* [ ] SD/MMC 버퍼 크기 및 DMA 설정에 따른 성능 변화 실험

---

## ✅ 9. **실제 테스트 및 호환성 확인**

### 💡 완성 후 고려할 점

* [ ] Windows 탐색기에서 인식 테스트 (MTP)
* [ ] Android MTP client 연결 테스트 (옵션)
* [ ] 특정 파일 형식만 전송 가능 여부 테스트
* [ ] 디바이스 속성/이름 변경 (USB descriptor 수정)

---

## 📝 정리: 공부해야 할 항목 요약표

| 범주           | 세부 학습 항목                       |
| ------------ | ------------------------------ |
| 기초 지식        | SD, USB, FAT, MTP 프로토콜 이해      |
| CubeMX 설정    | SDMMC, USB, FATFS, DMA 설정      |
| SD 카드 접근     | FATFS API, SD 드라이버 구성          |
| USB 디바이스     | Descriptor, Class, Endpoint 처리 |
| MTP 프로토콜     | Operation Code, 파일 전송 흐름       |
| USBX 활용 (선택) | ThreadX, USBX 구조 분석            |
| 디버깅/테스트      | UART, CubeMonitor, PC 연결 실험    |

---

필요하시면 위 항목별로 **추천 예제**, **문서**, 또는 **CubeMX 설정 예시**도 드릴 수 있습니다.
원하시는 학습 경로가 있으신가요? (예: "1단계부터 따라하며 배우는 MTP + SD 카드 프로젝트 구성")
