# MTP_Custom_Storage-
MTP_Custom_Storage 

μΆ‹μµλ‹λ‹¤! STM32H7B0VBT6 λ³΄λ“μ—μ„ **MicroSD μΉ΄λ“μ— MTP(Media Transfer Protocol) λ°©μ‹μΌλ΅ νμΌμ„ μ €μ¥**ν•λ” κ³Όμ •μ„ **μ•„μ£Ό μ‰½κ²** μ„¤λ…λ“λ¦¬κ² μµλ‹λ‹¤.

---

## π”· λ©ν‘

> PCμ— USBλ΅ μ—°κ²°ν–μ„ λ•
> β€λ””μ¤ν¬ λ“λΌμ΄λΈ(F:)β€μ²λΌ λ³΄μ΄μ§€ μ•κ³ ,
> β€ν΄λ€ν°μ²λΌβ€ λ³΄μ΄λ©΄μ„
> MicroSDμ— νΉμ • νμΌ(.txt, .doc, .hwp λ“±)μ„ **MTP λ°©μ‹μΌλ΅ μ „μ†΅**ν•λ” μ¥μΉλ¥Ό λ§λ“λ” κ²ƒ

---
## https://github.com/STMicroelectronics/stm32-usbx-examples 
---

## π”· μ „μ²΄ κ·Έλ¦Ό

```plaintext
     [PC]
      β”‚
      β”‚  USB μ—°κ²° (MTP ν”„λ΅ν† μ½)
      β–Ό
+-----------------------+
| STM32H7B0VBT6 λ³΄λ“    |
|                       |
| β‘  USB Device (MTP)   β—„β”€β”€β”€β”€ PCκ°€ μΈμ‹
| β‘΅ νμΌ μμ‹           β”‚
| β‘Ά SDMMCλ΅ microSDμ— μ €μ¥
+-----------------------+
```

---

## π”· ν•µμ‹¬ μ›λ¦¬ λ‹¨κ³„λ³„ μ„¤λ…

### β… 1λ‹¨κ³„: **PCμ™€ ν†µμ‹  β€“ USB MTP ν”„λ΅ν† μ½**

* **PCλ” USBλ¥Ό ν†µν•΄ STM32λ¥Ό 'MTP μ¥μΉ'λ΅ μΈμ‹**ν•©λ‹λ‹¤.
  ν΄λ€ν°μ²λΌ λ³΄μ…λ‹λ‹¤. (μ: β€Galaxy MTP μ¥μΉβ€μ²λΌ)
* μ΄λ¥Ό μ„ν•΄ STM32λ” **USB Device Stack + MTP Class**λ¥Ό κµ¬ν„ν•΄μ•Ό ν•©λ‹λ‹¤.

> β— κΈ°λ³Έ USB MSC(Mass Storage)λ” "F λ“λΌμ΄λΈ"μ²λΌ λ³΄μ΄μ§€λ§,
> MTPλ” "ν΄λ€ν° λ‚΄λ¶€ μ €μ¥μ†"μ²λΌ λ³΄μ…λ‹λ‹¤.

---

### β… 2λ‹¨κ³„: **STM32κ°€ νμΌμ„ μμ‹ **

* PC μ‚¬μ©μκ°€ `.txt`, `.doc` λ“±μ νμΌμ„ λ³µμ‚¬ν•λ©΄
* STM32λ” **MTP μ”μ²­μ„ ν•΄μ„**ν•κ³ ,
* μ „μ†΅λ°›μ€ νμΌ λ°μ΄ν„°λ¥Ό RAM(λλ” λ²„νΌ)μ— μ €μ¥ν•©λ‹λ‹¤.

> μ΄ λ• `MTP_WriteData_FS()` κ°™μ€ ν•¨μκ°€ νΈμ¶λ©λ‹λ‹¤.

---

### β… 3λ‹¨κ³„: **SDMMCλ΅ microSDμ— νμΌ μ €μ¥**

* STM32λ” λ°›μ€ νμΌμ„ **FATFS**λ¥Ό ν†µν•΄
  **microSD μΉ΄λ“μ— μ €μ¥**ν•©λ‹λ‹¤.

```c
// μμ‹ (MTP μμ‹  ν›„)
f_open(&file, "file.txt", FA_WRITE | FA_CREATE_ALWAYS);
f_write(&file, buffer, length, &bw);
f_close(&file);
```

* μ΄λ• **SDMMC μΈν„°νμ΄μ¤**λ¥Ό ν†µν•΄ λΉ λ¥΄κ² μ €μ¥λ©λ‹λ‹¤.
* SPIλ³΄λ‹¤ λΉ λ¥΄κ³  μ•μ •μ μ…λ‹λ‹¤.

---

### β… 4λ‹¨κ³„: **νμΌ ν•μ‹ ν•„ν„°λ§ (μµμ…)**

* `.hwp`, `.doc`, `.txt`λ§ μ €μ¥λλ„λ΅
  `filename`μ„ λ¶„μ„ν•μ—¬ ν•„ν„°λ§ν•  μ μμµλ‹λ‹¤.

```c
if (ends_with(filename, ".txt") || ...) {
    // μ €μ¥ ν—μ©
} else {
    // λ¬΄μ‹
}
```

---

## π§  μ”μ•½ ν• μ¤„

> **STM32λ” USB MTP μ¥μΉλ΅ λ™μ‘ν•μ—¬ PCλ΅λ¶€ν„° νμΌμ„ λ°›κ³ ,
> μ΄λ¥Ό microSD μΉ΄λ“μ— SDMMC μΈν„°νμ΄μ¤λ¥Ό ν†µν•΄ μ €μ¥ν•λ” μ¥μΉμ…λ‹λ‹¤.**

---

## π’΅ λ³΄λ„μ¤: μ™ MTPμΈκ°€μ”?

| λ°©μ‹                                | μ„¤λ…                | μ¥μ           | λ‹¨μ         |
| --------------------------------- | ----------------- | ----------- | --------- |
| **MSC (Mass Storage)**            | PCκ°€ SDμΉ΄λ“λ¥Ό μ§μ ‘ μ—½λ‹λ‹¤  | κµ¬ν„ μ‰¬μ›€       | FAT μ¶©λ μ„ν— |
| **MTP (Media Transfer Protocol)** | STM32κ°€ μ§μ ‘ SDμΉ΄λ“ μ μ–΄ | μ•μ „ν•¨, ν•„ν„°λ§ κ°€λ¥ | κµ¬ν„ λ³µμ΅     |

---

ν•„μ”ν•μ‹λ©΄:

* STM32CubeIDE μ„¤μ • μμ„
* `usbd_mtp_if.c` μ‘μ„±λ²•
* FATFS μ—°λ™ μμ 
  λ„ λ‹¨κ³„λ³„λ΅ μ•λ ¤λ“λ¦΄ μ μμµλ‹λ‹¤!


STM32H7B0VBT6μ μ‚¬μ–‘μ— κ°€μ¥ μ ν•©ν• MTP κµ¬ν„ λ°©μ‹μ€ λ‹¤μκ³Ό κ°™μµλ‹λ‹¤:

---

## β… **μµμ μ κµ¬ν„ λ°©μ‹ μ”μ•½**

| ν•­λ©              | μ„ νƒ                                        | μ΄μ                                                          |
| --------------- | ----------------------------------------- | ---------------------------------------------------------- |
| **SD μΉ΄λ“ μΈν„°νμ΄μ¤** | **SDMMC**                                 | H7B0μ€ **2Γ— SDMMC** (μµλ€ 133 MHz)λ¥Ό μ§€μ›ν•μ—¬ **SPIλ³΄λ‹¤ ν›¨μ”¬ λΉ λ¥΄κ³  μ•μ •μ ** |
| **USB μΈν„°νμ΄μ¤**   | **USB Device (USB OTG FS/HS)**            | STM32H7B0μ€ **USB OTG** μ§€μ› β†’ MTP κµ¬ν„ κ°€λ¥                      |
| **νμΌμ‹μ¤ν…**       | **FATFS**                                 | STM32CubeMXμ—μ„ κ³µμ‹ μ§€μ›, microSD μ—°λ™μ— ν‘μ¤€μ                        |
| **MTP κµ¬ν„ κΈ°λ°**   | **USBX κΈ°λ° MTP μμ ** (`Ux_Device_PIMA_MTP`) | STμ—μ„ μ κ³µ, H7 κ³„μ—΄μ— μ ν•©, USB + FATFS μ—°λ™ κ²½ν— λ§μ                   |
| **OS μ‚¬μ© μ—¬λ¶€**    | **RTOS κΈ°λ° κµ¬ν„ (USBX)** κ¶μ¥                  | λ³µμ΅ν• USB ν†µμ‹ , νμΌ I/O μ²λ¦¬μ— μ•μ •μ                                  |

---

## β… μ¶”μ² κµ¬ν„ λ¦¬ν¬μ§€ν† λ¦¬

> **[STMicroelectronics/stm32-usbx-examples](https://github.com/STMicroelectronics/stm32-usbx-examples)**

* λ””λ ‰ν„°λ¦¬: `/Projects/STM32H7B3I_EVAL/Applications/USBX/Ux_Device_PIMA_MTP`
* νΉμ§•:

  * **USBX + ThreadX κΈ°λ° MTP μ¥μΉ μμ **
  * STM32H7 κ³„μ—΄μ©μΌλ΅ κµ¬μ„±
  * **SDMMC + FATFS μ—°λ™** μμ λ΅ ν™•μ¥ κ°€λ¥
  * CubeIDEλ΅ μ—΄μ–΄μ„ λ°”λ΅ λΉλ“ λ° μμ • κ°€λ¥

---

## β… κµ¬ν„ νλ¦„

```plaintext
[PC] β‡„ USB MTP β‡„ [STM32H7B0VBT6] β‡„ SDMMC β‡„ microSD
        β”‚                   β”‚
      USBX              FATFS
        β”‚                   β”‚
   usbd_mtp_if.c       f_write()
```

1. USBXλ΅ MTP μ”μ²­ μμ‹ 
2. μ”μ²­ν• νμΌλ…μ„ `usbd_mtp_if.c`μ—μ„ ν•„ν„°λ§ (`.hwp`, `.txt`, `.doc`)
3. μ ν¨ν•λ©΄ `f_open` + `f_write`λ΅ microSDμ— μ €μ¥

---

## β… μ¥μ 

* **H7B0μ κ°•λ ¥ν• μ„±λ¥** ν™μ© (Cortex-M7 + L1 cache + DMA)
* **κ³ μ† USB + SDMMC** μ΅°ν•© β†’ λΉ λ¥΄κ³  μ•μ •μ 
* STμ—μ„ μ κ³µν•λ” μμ λ¥Ό μ‚¬μ©ν•λ©΄ **νΈν™μ„± ν™•λ³΄ λ° μ μ§€λ³΄μ μ©μ΄**

---

## β… κ²°λ΅ 

π”· STM32H7B0VBT6μ— κ°€μ¥ μ ν•©ν• λ°©λ²•μ€
**STμ USBX κΈ°λ° MTP μμ λ¥Ό μ‚¬μ©ν•μ—¬, SDMMC μΈν„°νμ΄μ¤λ΅ microSDμ— FATFS λ°©μ‹μΌλ΅ μ €μ¥ν•λ” κµ¬μ΅°**μ…λ‹λ‹¤.

> ν•„μ” μ‹: μ„ μμ λ¥Ό H7B0VBT6 λ³΄λ“μ— λ§κ² **ν¬ν… λ°©λ²•**κ³Ό
> `usbd_mtp_if.c` μ½”λ“ μƒν”λ„ λ‹¨κ³„λ³„λ΅ μ•λ ¤λ“λ¦΄ μ μμµλ‹λ‹¤.

