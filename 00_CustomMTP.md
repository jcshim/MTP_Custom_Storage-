Custom MTP(Media Transfer Protocol) ìŠ¤íƒì„ STM32 ê¸°ë°˜ MCUì—ì„œ ì§ì ‘ ì„¤ê³„í•˜ë ¤ëŠ” ê²½ìš°, \*\*MTP í”„ë¡œí† ì½œ ëª…ì„¸(PIMA 15740)\*\*ë¥¼ ë°”íƒ•ìœ¼ë¡œ í•˜ì—¬, USB í‘œì¤€ ìš”ì²­ ì²˜ë¦¬ë¶€í„° íŒŒì¼ ëª©ë¡ ê´€ë¦¬, ë°ì´í„° ì†¡ìˆ˜ì‹ , ì‘ë‹µê¹Œì§€ **ì „ì²´ íë¦„ì„ ì§ì ‘ êµ¬í˜„**í•´ì•¼ í•©ë‹ˆë‹¤. ì•„ë˜ì— ê·¸ êµ¬ì¡°ì™€ íë¦„ì„ **ë‹¨ê³„ë³„ë¡œ ì‹œê°ì  íë¦„ë„ ê°œë… + ì„¤ëª…**ìœ¼ë¡œ ì •ë¦¬í•´ ë“œë¦½ë‹ˆë‹¤.

---

## âœ… Custom MTP ìŠ¤íƒ ì „ì²´ íë¦„ë„ (ìš”ì•½ ê°œë…ë„)

```
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚   Windows  â”‚
    â”‚(MTP Client)â”‚
    â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚ â‘  USB Setup Packet (MTP Command)
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ STM32 USB Device RX â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ MTP Container Parserâ”‚ â†â”€â”€â”€ Header + Payload
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ MTP Operation Dispatcher     â”‚  â† ì˜ˆ: GetDeviceInfo, GetObject
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
         â–¼              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ íŒŒì¼ ì‹œìŠ¤í…œ â”‚   â”‚ ì˜¤ë¸Œì íŠ¸ ëª©ë¡ â”‚
â”‚ (FATFS/SDMMC)â”‚   â”‚ (Object Table)â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â–¼              â–²
     â‘¤ íŒŒì¼ ì½ê¸°        â”‚
         â–¼              â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ MTP Data Response TXâ”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â–¼
   â‘¥ USB IN ì „ì†¡
         â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚  Windows   â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ“Œ ë‹¨ê³„ë³„ ì„¤ëª… (Custom MTP ìŠ¤íƒ êµ¬ì„± ìš”ì†Œ)

### ğŸ”¹ â‘  USB Setup íŒ¨í‚· ìˆ˜ì‹ 

* `usbd_mtp.c`ì—ì„œ `USBD_LL_DataReceived()` ë“± ì½œë°±ìœ¼ë¡œ **PCê°€ ë³´ë‚¸ ìš”ì²­ íŒ¨í‚·**ì„ ìˆ˜ì‹ 
* ê° ìš”ì²­ì€ MTP Container í˜•ì‹ìœ¼ë¡œ ì „ë‹¬ë¨

  * `OperationCode`, `TransactionID`, `Parameter[]` ë“± í¬í•¨
* ìš”ì²­ ì¢…ë¥˜ ì˜ˆì‹œ:

  * `GetDeviceInfo`, `GetStorageIDs`, `GetObjectHandles`, `GetObject`, `SendObject`, `DeleteObject`

---

### ğŸ”¹ â‘¡ MTP Container íŒŒì‹±

* ìˆ˜ì‹ ëœ `64~512 byte`ì˜ ë²„í¼ì—ì„œ MTP Container êµ¬ì¡° í•´ì„

```c
typedef struct {
  uint32_t length;
  uint16_t type;         // Command, Data, Response ë“±
  uint16_t opCode;       // ex. 0x1001: GetDeviceInfo
  uint32_t transactionId;
  uint32_t parameters[5];
} MTP_Container_t;
```

* íŒŒì‹± í›„ Dispatcherë¡œ ì „ë‹¬

---

### ğŸ”¹ â‘¢ MTP Operation Dispatcher

* `opCode` ê°’ì„ ê¸°ì¤€ìœ¼ë¡œ **í•¸ë“¤ëŸ¬ í•¨ìˆ˜** í˜¸ì¶œ

```c
switch (container.opCode) {
  case MTP_OP_GetDeviceInfo:
    return MTP_Handle_GetDeviceInfo(&container);
  case MTP_OP_GetObjectHandles:
    return MTP_Handle_GetObjectHandles(&container);
  case MTP_OP_GetObject:
    return MTP_Handle_GetObject(&container);
}
```

* DispatcherëŠ” ì²˜ë¦¬ í›„ ì‘ë‹µ(response or data)ì„ ì¤€ë¹„

---

### ğŸ”¹ â‘£ íŒŒì¼ ì‹œìŠ¤í…œ / ì˜¤ë¸Œì íŠ¸ í…Œì´ë¸” ì—°ë™

* `FATFS + SDMMC`ë¡œë¶€í„° íŒŒì¼ ëª©ë¡ ë˜ëŠ” ì‹¤ì œ íŒŒì¼ì„ ì½ìŒ
* â€œObjectâ€ëŠ” MTPì—ì„œ íŒŒì¼/ë””ë ‰í† ë¦¬ë¥¼ ì˜ë¯¸í•¨
* ObjectTableì€ ë‹¤ìŒê³¼ ê°™ì€ êµ¬ì¡°ë¡œ ìœ ì§€

```c
typedef struct {
  uint32_t handle;
  char filename[64];
  uint32_t size;
  uint16_t formatCode; // ex. 0x3004 = text, 0x3005 = doc
  uint32_t parentHandle;
} MTP_Object_t;
```

* PC ìš”ì²­ì— ë”°ë¼ í•¸ë“¤ ëª©ë¡ ë˜ëŠ” ë©”íƒ€ë°ì´í„° ì „ì†¡

---

### ğŸ”¹ â‘¤ ë°ì´í„° ì „ì†¡ ì¤€ë¹„ (Data Response)

* ìš”ì²­ ìœ í˜•ì— ë”°ë¼:

  * Command í›„ `Data Phase` í•„ìš” (ì˜ˆ: GetObject)
  * ë°”ë¡œ Response ë³´ë‚´ëŠ” ê²½ìš°ë„ ìˆìŒ
* ë°ì´í„°ë¥¼ **USB IN Endpointë¡œ ë³´ë‚´ê¸° ìœ„í•œ ë²„í¼**ì— ì¤€ë¹„

---

### ğŸ”¹ â‘¥ USB ì „ì†¡ (IN)

* `USBD_LL_Transmit()` í•¨ìˆ˜ í˜¸ì¶œë¡œ MTP ë°ì´í„° ì „ì†¡
* ì—¬ëŸ¬ íŒ¨í‚·ìœ¼ë¡œ ë¶„í•  ì „ì†¡ í•„ìš” (íŒŒì¼ì€ ìˆ˜ë°± KB ì´ìƒ)

---

## ğŸ§  ì„¤ê³„ ì‹œ ê³ ë ¤í•  í•µì‹¬ í¬ì¸íŠ¸

| í•­ëª©                   | ì„¤ëª…                                                                 |
| -------------------- | ------------------------------------------------------------------ |
| **Object Handle ê´€ë¦¬** | íŒŒì¼ë§ˆë‹¤ ê³ ìœ  ë²ˆí˜¸(í•¸ë“¤) ë¶€ì—¬ ë° ì¡°íšŒ í•„ìš”                                          |
| **MTP ìƒíƒœ ì „ì´ ê´€ë¦¬**     | Command â†’ Data â†’ Response ìˆœì„œ ë³´ì¥                                    |
| **íŒŒì¼ í•„í„°ë§**           | `.hwp`, `.doc`, `.txt` ë“±ë§Œ ë¦¬ìŠ¤íŠ¸ì— í¬í•¨                                  |
| **ëŒ€ìš©ëŸ‰ ì „ì†¡**           | íŒ¨í‚· ë¶„í•  (bulk endpoint 64/512 byte) ë° offset ê¸°ë°˜ ì „ì†¡                   |
| **Windows í˜¸í™˜ì„±**      | `GetDeviceInfo`, `GetObjectHandles`, `GetObjectInfo` ë“± ì£¼ìš” ìš”ì²­ êµ¬í˜„ í•„ìˆ˜ |
| **ë””ë²„ê¹…**              | UART printf, Wireshark USB ë¶„ì„, Logic Analyzer ë³‘í–‰ ì‚¬ìš©                |

---

## ğŸ§± í•µì‹¬ êµ¬í˜„ íŒŒì¼ êµ¬ì¡° ì˜ˆì‹œ (Custom ë°©ì‹)

```
/usb_device
â”œâ”€â”€ usbd_mtp.c / .h         # USB ìš”ì²­ ì²˜ë¦¬, EndPoint ì—°ê²°
â”œâ”€â”€ mtp_parser.c / .h       # Container íŒŒì‹±
â”œâ”€â”€ mtp_dispatcher.c / .h   # ìš”ì²­ë³„ í•¸ë“¤ëŸ¬ ë§¤í•‘
â”œâ”€â”€ mtp_object.c / .h       # íŒŒì¼ â†’ Object ë³€í™˜
â”œâ”€â”€ mtp_fileio.c / .h       # FATFS + íŒŒì¼ ì½ê¸°/ì“°ê¸°
```

---

## ğŸ“˜ ì°¸ê³  ìë£Œ (í•„ìˆ˜ ë¬¸ì„œ)

| ë¬¸ì„œëª…                                                                                                           | ì„¤ëª…                                     |
| ------------------------------------------------------------------------------------------------------------- | -------------------------------------- |
| [PIMA 15740](https://www.usb.org/document-library/pima-15740-device-independent-protocol-standard)            | MTP í‘œì¤€ ë¬¸ì„œ                              |
| [USB Device Class Definitions for MTP](https://learn.microsoft.com/en-us/windows-hardware/drivers/usbcon/mtp) | Microsoft MTP ìŠ¤í™                       |
| STM32 USB Device Library                                                                                      | `usbd_core.c`, `usbd_ctlreq.c` ë“± êµ¬ì¡° ì°¸ê³  |

---

## âœ‹ ì •ë¦¬

Custom MTP ìŠ¤íƒì€ ë³µì¡í•˜ì§€ë§Œ ìœ ì—°ì„±ê³¼ ì œì–´ë ¥ì„ ê·¹ëŒ€í™”í•  ìˆ˜ ìˆëŠ” ë°©ì‹ì…ë‹ˆë‹¤.
íŠ¹íˆ `.hwp`, `.txt`, `.doc`ë§Œ ë³´ì´ê²Œ í•˜ê±°ë‚˜ íŠ¹ì • í´ë”ë§Œ ë…¸ì¶œí•˜ë ¤ë©´ ì§ì ‘ êµ¬í˜„ì´ ì í•©í•©ë‹ˆë‹¤.

ì›í•˜ì‹ ë‹¤ë©´ ë‹¤ìŒë„ ë„ì™€ë“œë¦´ ìˆ˜ ìˆìŠµë‹ˆë‹¤:

* MTP ëª…ë ¹ì–´ë³„ êµ¬í˜„ ì˜ˆì‹œ
* ìµœì†Œ êµ¬í˜„ ìš”êµ¬ ëª…ë ¹ ë¦¬ìŠ¤íŠ¸ (`GetDeviceInfo`, `GetObject`, ë“±)
* ì˜ˆì œ ì½”ë“œ í…œí”Œë¦¿

ì§„í–‰í•˜ê³ ì í•˜ì‹œëŠ” ë°©í–¥(ì˜ˆ: MTP íŒŒì¼ í•„í„°ë§ ìœ„ì£¼, ìµœì†Œ ë™ì‘ MTP êµ¬í˜„ ë“±)ì„ ì•Œë ¤ì£¼ì‹œë©´ ë§ì¶¤ ê°€ì´ë“œë¥¼ ë“œë¦´ ìˆ˜ ìˆìŠµë‹ˆë‹¤.
